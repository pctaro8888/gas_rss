
//-----------------------------------------------------------
// æ©Ÿèƒ½åã€€ï¼šRSSãƒ•ã‚£ãƒ¼ãƒ‰LINEé€ä¿¡.gs
// æ©Ÿèƒ½æ¦‚è¦ï¼šRSSãƒ•ã‚£ãƒ¼ãƒ‰ã®å†…å®¹ã‚’LINEã«é€ä¿¡ã™ã‚‹
// å¼•æ•°  ã€€ï¼šãªã—
// ä½œæˆæ—¥ã€€ï¼š2025.05.22
//-----------------------------------------------------------

// ç¾åœ¨æ—¥æ™‚ã‚’ã€ŒYYYY/MM/DD HH:mmã€å½¢å¼ã§å–å¾—ã™ã‚‹é–¢æ•°
function getFormattedDate() {
  const now = new Date();  // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
  const yyyy = now.getFullYear();                      // å¹´
  const mm = String(now.getMonth() + 1).padStart(2, '0'); // æœˆï¼ˆ0å§‹ã¾ã‚Šã®ãŸã‚+1ï¼‰
  const dd = String(now.getDate()).padStart(2, '0');      // æ—¥
  const hh = String(now.getHours()).padStart(2, '0');     // æ™‚
  const min = String(now.getMinutes()).padStart(2, '0');  // åˆ†
  return `${yyyy}/${mm}/${dd} ${hh}:${min}`; // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦è¿”å´
}

// RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã€å†…å®¹ã‚’LINEã«é€ä¿¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
function notifyRSSToLINE() {
  const rssUrl = "https://rss.app/feeds/_MXej92d3nzGSnaDS.xml"; // å¯¾è±¡ã®RSSãƒ•ã‚£ãƒ¼ãƒ‰URL
  const token = "/WasjrDq1cZe0IXi3priP3KolyPoMIoaggWbLpTsiHKRTbw+WWVXW5261eP+slUgx1MJo1t95JfBNkSRneAOEWj+n5OJKgGaCJcbRQ9BfypMsFYdXCzezPwDI832ZDc65fTf+kFzrG4EBo1mes0YigdB04t89/1O/w1cDnyilFU="; // LINE Messaging APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆâ€»å®Ÿéš›ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç­‰ã«ä¿å­˜æ¨å¥¨ï¼‰

  let content = UrlFetchApp.fetch(rssUrl).getContentText(); // RSSãƒ•ã‚£ãƒ¼ãƒ‰ã®XMLã‚’ãƒ†ã‚­ã‚¹ãƒˆã§å–å¾—

  // XMLè§£æå‰ã«ä¸æ­£ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆ&ãŒå¤šé‡ã«å«ã¾ã‚Œã‚‹ã¨ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ï¼‰
  content = content.replace(/&(?!amp;|lt;|gt;|quot;|apos;)/g, '&amp;');
  const xml = XmlService.parse(content); // XMLã‚’ãƒ‘ãƒ¼ã‚¹
  const items = xml.getRootElement().getChild("channel").getChildren("item"); // <channel>å†…ã®<item>è¦ç´ ã‚’å–å¾—

  try {
    let messages = [];

    // ğŸ“Œ ç¾åœ¨æ—¥æ™‚ã‚’æœ€åˆã«è¿½åŠ 
    const now = getFormattedDate();
    messages.push(`ğŸ•’ é€ä¿¡æ—¥æ™‚: ${now}`);

    // å„RSSã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒªãƒ³ã‚¯ã‚’æ•´å½¢ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ 
    items.forEach(item => {
      const title = item.getChildText("title"); // è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
      const link = item.getChildText("link");   // è¨˜äº‹ãƒªãƒ³ã‚¯
      messages.push(`ğŸ“° ${title}\nğŸ”— ${link}`);
    });

    // LINEã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
    const payload = {
      messages: [{
        type: "text",
        text: messages.join("\n\n") // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹è¡Œã§é€£çµ
      }]
    };

    // LINE Messaging APIã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    UrlFetchApp.fetch("https://api.line.me/v2/bot/message/broadcast", {
      method: "post",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      payload: JSON.stringify(payload)
    });

    Logger.log(`âœ… èª­ã¿è¾¼ã¿æˆåŠŸ: ${items.length}ä»¶`);

  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›
    Logger.log(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ`);
    Logger.log(e.message);
  }
}
